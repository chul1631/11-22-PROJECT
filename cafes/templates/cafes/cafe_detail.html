{% extends 'base.html' %}

{% load django_bootstrap5 %}
{% load static %}

{% block css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'cafes/css/cafe_detail.css' %}">
{% endblock css %}

{% block content %}
  <!-- 최상단 정보 -->
  <div class="titles">
    <div class="cafe-left">
      <!-- 카페 이름, 평점 -->
      <div class="cafe-upper">
        <p class="cafe-name">{{ article.name }}</p>
        <!-- 평점 -->
        <p class="rate-number">{{ rate_avg }}</p>
      </div>

      <!-- 조회수, 좋아요, 북마크, 공유 -->
      <div class="cafe-lower">
        <!-- 조회수 -->
        <div class="views me-1">
          <button class="btn btn-secondary disabled">
            <img src="https://cdn-icons-png.flaticon.com/512/159/159604.png" alt="조회수 아이콘">
            <span class="ms-1">{{ article.hits }}</span>
          </button>
        </div>
        <!-- 좋아요 -->
        <div class="like me-1">
          {% if request.user.is_authenticated %}
            <form id="cafe-like-form" data-article-id="{{ article.pk }}">
              {% csrf_token %}
              <button class="btn btn-danger" type='submit'>
                <img src="https://cdn-icons-png.flaticon.com/512/5881/5881205.png" alt="좋아요 아이콘">
                <span id="cafe-like-count" class="ms-1">{{ article.like_users.count }}</span>
              </button>
            </form>
          {% else %}
            <button class="btn btn-danger disabled">
              <img src="https://cdn-icons-png.flaticon.com/512/5881/5881205.png" alt="좋아요 아이콘">
              <span id="cafe-like-count" class="ms-1">{{ article.like_users.count }}</span>
            </button>
          {% endif %}
        </div>
        <!-- 북마크 -->
        <div class="bookmark me-1">
          {% if request.user.is_authenticated %}
            <form id="cafe-bookmark-form" data-article-id="{{ article.pk }}">
              {% csrf_token %}
              <button class="btn btn-success" type='submit'>
                <img src="https://cdn-icons-png.flaticon.com/512/3303/3303088.png" alt="북마크 아이콘">
                <span id="cafe-bookmark-count" class="ms-1">{{ article.bookmark_users.count }}</span>
              </button>
            </form>
          {% else %}
            <button class="btn btn-success disabled">
              <img src="https://cdn-icons-png.flaticon.com/512/3303/3303088.png" alt="북마크 아이콘">
              <span id="bookmark-count" class="ms-1">{{ article.bookmark_users.count }}</span>
            </button>
          {% endif %}
        </div>
        <!-- 공유 -->
        <div class="share">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shareModal">
            <img src="https://cdn-icons-png.flaticon.com/512/1330/1330134.png" alt="공유 아이콘">
            <span class="ms-1">공유</span>
          </button>
        </div>

        <!-- 공유 Modal -->
        <div class="modal fade" id="shareModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content" style="background-color: #61764B;">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">공유하기</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>다음 링크를 복사해주세요.</p>
                <p>{{ request.build_absolute_uri }}</p>
                <!-- 절대 링크 -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 수정 버튼 -->
    <div class="cafe-right">
      {% if request.user == article.user %}
        <a class="edit-button" href="{% url 'cafes:cafe_update' article.pk %}">
          <img src="https://cdn-icons-png.flaticon.com/512/1014/1014883.png" alt="수정 아이콘">
          <p>수정</p>
        </a>
      {% endif %}
    </div>
  </div>

  <!-- 이미지/캐러셀 -->
  <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{{ article.image1.url }}" class="d-block w-100 rounded" alt="..."/>
      </div>
      <div class="carousel-item">
        <img src="{{ article.image2.url }}" class="d-block w-100 rounded" alt="..."/>
      </div>
      <div class="carousel-item">
        <img src="{{ article.image3.url }}" class="d-block w-100 rounded" alt="..."/>
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <!-- 가게 상세 -->
  <div class="row mt-5 g-4">
    <div class="col-sm-12 col-lg-9">
      <div class="card">
        <div class="card-body">
          <p>
            주소 :
            <span id="cafe-address">{{ article.address }}</span>
          </p>
          <p>
            <div id="map" class="rounded" style="width: 100%; height: 350px;"></div>
          </p>
          <p>
            전화번호 :
            {{ article.number }}
          </p>
          <p>
            영업 시간 :
            {{ article.opening_hour }}
          </p>
          <p>
            휴일 :
            {{ article.dayoff }}
          </p>
          <p>
            주차 :
            {{ article.parking }}
          </p>
          <p>
            {{ article.menu|safe }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-lg-3">
      <div class="card">
        <div class="card-body opacity-20 text-center">
          <p>
            이 매장이 소개된 테마
          </p>
          <p>
            <img src="https://dummyimage.com/200x200" alt="">
          </p>
          <p>
            {{ article.cafeType }}
          </p>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-4">
      <h2 class="my-auto fw-bold text-white">후기</h2>
      <div class="d-flex">
        <div class="dropdown text-end">
          <select class="down form-select" onchange="if(this.value) location.href=(this.value);">
            <option value="" disabled="disabled" selected="selected">정렬 선택</option>
            <option value="{% url 'cafes:cafe_detail_new' article.pk %}">최신순</option>
            <option value="{% url 'cafes:cafe_detail_good' article.pk %}">좋아요순</option>
          </select>
        </div>
        {% if request.user.is_authenticated %}
          <a class="btn btn-primary ms-1 my-auto" href="{% url 'cafes:review_create' article.pk %}">후기 작성</a>
        {% else %}
          <a class="btn btn-primary ms-1 my-auto disabled">후기 작성</a>
        {% endif %}
      </div>
    </div>
    {% for review in reviews %}
      <div id="review-{{ review.pk }}" class="card w-100 review-area">
        <div class="card-body">
          <div class="d-flex mb-1">
            {% if review.user.profile %}
              <img class="rounded" src="{{ review.user.profile.url }}" alt="기본 프로필 사진" style="max-height: 100px">
            {% else %}
              <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
            {% endif %}
            <div class="ms-4 flex-fill">
              <div class="mb-1">
                <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user }}</a>
              </div>
              <div class="mb-1">
                <div class="d-flex">
                  {% if review.rate == 0.0 %}
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 0.5 %}
                    <i class="p-0 bi bi-star-half fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 1.0 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 1.5 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-half fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 2.0 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 2.5 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-half fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 3.0 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 3.5 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-half fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 4.0 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star fs-5 text-warning"></i>
                  {% elif review.rate == 4.5 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-half fs-5 text-warning"></i>
                  {% elif review.rate == 5.0 %}
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                    <i class="p-0 bi bi-star-fill fs-5 text-warning"></i>
                  {% endif %}
                </div>
              </div>
              <div class="mb-1">
                {{ review.content|safe }}
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between">
            <div class="d-flex">
              <button class="btn btn-sm border-0 text-secondary comment-btn" data-review-id="{{ review.pk }}">
                <i class="bi bi-chat-left-dots"></i>
                <span class="ms-2 comment-{{ review.pk }}-count">{{ review.comment_set.count }}</span>
              </button>
              {% if request.user.is_authenticated %}
                <form class="review-like-form" data-article-id="{{ article.pk }}" data-review-id="{{ review.pk }}">
                  {% csrf_token %}
                  <button class="btn btn-sm border-0 text-danger" type="submit">
                    {% if request.user in review.like_users.all %}
                      <i class="bi bi-heart-fill review-like-icon"></i>
                    {% else %}
                      <i class="bi bi-heart review-like-icon"></i>
                    {% endif %}
                    <span class="ms-2 review-like-count">{{ review.like_users.count }}</span>
                  </button>
                </form>
              {% endif %}
            </div>
            {% if request.user == review.user %}
              <div class="d-flex">
                <a class="btn btn-sm border-0 text-black" href="{% url 'cafes:review_update' article.pk review.pk %}">
                  <i class="bi bi-pencil"></i>
                </a>
                <form action="{% url 'cafes:review_delete' article.pk review.pk %}" method="POST">
                  {% csrf_token %}
                  <button class="btn btn-sm border-0 text-danger" type="submit">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
          <hr>
          <div id="comment-area-{{ review.pk }}" class="d-none">
            {% if request.user.is_authenticated %}
              <form class="comment-create-form" data-review-id="{{ review.pk }}">
                {% csrf_token %}
                <div class="d-flex justify-content-between align-items-center">
                  <div class="flex-fill me-2">
                    <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true">
                  </div>
                  <div>
                    <input class="btn btn-primary" type="submit" value="작성">
                  </div>
                </div>
              </form>
              <hr>
            {% endif %}
            {% for comment in review.root_comments %}
              <div id="comment-{{ comment.pk }}">
                <div id="comment-{{ comment.pk }}-block" class="d-flex mb-1 d-block">
                  {% if comment.user.profile %}
                    <img class="rounded" src="{{ comment.user.profile.url }}" alt="기본 프로필 사진" style="max-height: 100px">
                  {% else %}
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                  {% endif %}
                  <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                    <div class="my-2">
                      <a href="{% url 'accounts:profile' comment.user.username %}">{{ comment.user }}</a>
                    </div>
                    <div id="comment-{{ comment.pk }}-content" class="my-2">{{ comment.content }}</div>
                  </div>
                </div>
                <div id="comment-{{ comment.pk }}-update" class="d-none">
                  {% if request.user.is_authenticated %}
                    <form class="comment-update-form" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
                      {% csrf_token %}
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="{{ comment.content }}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  {% endif %}
                </div>
                <div id="comment-{{ comment.pk }}-btn" class="d-flex justify-content-between">
                  {% if request.user.is_authenticated %}
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="{{ comment.pk }}">
                        <i class="bi bi-chat-left-dots"></i>
                        <span class="ms-2 reply-count">{{ comment.reply_set.count }}</span>
                      </button>
                      <form class="comment-like-form" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
                        {% csrf_token %}
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          {% if request.user in comment.like_users.all %}
                            <i class="bi bi-heart-fill"></i>
                          {% else %}
                            <i class="bi bi-heart"></i>
                          {% endif %}
                          <span class="ms-2 comment-like-count">{{ comment.like_users.count }}</span>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                  {% if request.user == review.user %}
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
                        {% csrf_token %}
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
                <div id="reply-form-{{ comment.pk }}" class="d-none">
                  {% if request.user.is_authenticated %}
                    <hr>
                    <form class="reply-create-form" data-review-id="{{ review.pk }}" data-comment-id="{{ comment.pk }}">
                      {% csrf_token %}
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  {% endif %}
                </div>
                {% with parent=comment reply_list=comment.reply_set.all %}
                  {% include 'cafes/reply.html' %}
                {% endwith %}
              </div>
              <hr>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
    <hr>
  </div>
{% endblock content %}
{% block js %}
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={% include 'cafes/appkey.txt' %}&libraries=services"></script>
  <script>
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
      mapOption = {
        center: new kakao
          .maps
          .LatLng(33.450701, 126.570667), // 지도의 중심좌표
        level: 3 // 지도의 확대 레벨
      };

    // 지도를 생성합니다
    var map = new kakao
      .maps
      .Map(mapContainer, mapOption);

    // 주소-좌표 변환 객체를 생성합니다
    var geocoder = new kakao
      .maps
      .services
      .Geocoder();

    // 주소로 좌표를 검색합니다
    geocoder.addressSearch(document.querySelector('#cafe-address').innerText, function (result, status) {

      // 정상적으로 검색이 완료됐으면
      if (status === kakao.maps.services.Status.OK) {

        var coords = new kakao
          .maps
          .LatLng(result[0].y, result[0].x);

        // 결과값으로 받은 위치를 마커로 표시합니다
        var marker = new kakao
          .maps
          .Marker({map: map, position: coords});

        // 인포윈도우로 장소에 대한 설명을 표시합니다
        var infowindow = new kakao
          .maps
          .InfoWindow({content: '<div style="width:150px;text-align:center;padding:6px 0;">HERE</div>'});
        infowindow.open(map, marker);

        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
        map.setCenter(coords);

      }
    });
  </script>
  <script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  </script>
  <script>
    const cafeLikeForm = document.querySelector('#cafe-like-form')
    cafeLikeForm.addEventListener('submit', function (event) {
      event.preventDefault()
      const articleId = event.currentTarget.dataset.articleId
      axios({
        method: 'POST',
        url: `/cafes/${articleId}/cafe_like/`,
        headers: { 'X-CSRFToken': csrftoken }
      })
      .then(response => {
        document.querySelector('#cafe-like-count').innerText = response.data.like_count
      })
    })
  </script>
  <script>
    const cafeBookmarkForm = document.querySelector('#cafe-bookmark-form')
    cafeBookmarkForm.addEventListener('submit', function (event) {
      event.preventDefault()
      const articleId = event.currentTarget.dataset.articleId
      axios({
        method: 'POST',
        url: `/cafes/${articleId}/cafe_bookmark/`,
        headers: { 'X-CSRFToken': csrftoken }
      })
      .then(response => {
        document.querySelector('#cafe-bookmark-count').innerText = response.data.bookmark_count
      })
    })
  </script>
  <script>
    const reviewLikeForms = document.querySelectorAll('.review-like-form')
    reviewLikeForms.forEach((reviewLikeForm) => {
      reviewLikeForm.addEventListener('submit', function (event) {
        event.preventDefault()
        const articleId = event.currentTarget.dataset.articleId
        const reviewId = event.currentTarget.dataset.reviewId
        axios({
          method: 'POST',
          url: `/cafes/${articleId}/review_like/${reviewId}/`,
          headers: { 'X-CSRFToken': csrftoken }
        })
        .then(response => {
          if (response.data.is_review_liked) {
            reviewLikeForm.querySelector('.review-like-icon').classList.remove('bi-heart')
            reviewLikeForm.querySelector('.review-like-icon').classList.add('bi-heart-fill')
          }
          else {
            reviewLikeForm.querySelector('.review-like-icon').classList.remove('bi-heart-fill')
            reviewLikeForm.querySelector('.review-like-icon').classList.add('bi-heart')
          }
          reviewLikeForm.querySelector('.review-like-count').innerText = response.data.review_like_count
        })
      })
    })
  </script>
  <script>
    const commentBtns = document.querySelectorAll('.comment-btn')
    commentBtns.forEach((commentBtn) => {
      commentBtn.addEventListener('click', function (event) {
        const reviewId = event.currentTarget.dataset.reviewId
        document.querySelector(`#comment-area-${reviewId}`).classList.toggle('d-none')
        document.querySelector(`#comment-area-${reviewId}`).classList.toggle('d-block')
      })
    })
  </script>
  <script>
    function commentUpdateBtn(dom) {
      const commentUpdateBtns = dom.querySelectorAll('.comment-update-btn')
      commentUpdateBtns.forEach((commentUpdateBtn) => {
        commentUpdateBtn.addEventListener('click', function (event) {
          const reviewId = event.currentTarget.dataset.reviewId
          const commentId = event.currentTarget.dataset.commentId
          dom.querySelector(`#comment-${commentId}-block`).classList.toggle('d-none')
          dom.querySelector(`#comment-${commentId}-block`).classList.toggle('d-block')
          dom.querySelector(`#comment-${commentId}-update`).classList.toggle('d-block')
          dom.querySelector(`#comment-${commentId}-update`).classList.toggle('d-none')
          dom.querySelector(`#comment-${commentId}-update .form-control`).value = commentUpdateBtn.offsetParent.querySelector(`#comment-${commentId}-content`).innerText
        })
      })
    }

    function replyBtn(dom) {
      const replyBtns = dom.querySelectorAll('.reply-btn')
      replyBtns.forEach((replyBtn) => {
        replyBtn.addEventListener('click', function (event) {
          const commentId = event.currentTarget.dataset.commentId
          dom.querySelector(`#reply-form-${commentId}`).classList.toggle('d-none')
          dom.querySelector(`#reply-form-${commentId}`).classList.toggle('d-block')
        })
      })
    }

    function commentLike(dom) {
      const commentLikeForms = dom.querySelectorAll('.comment-like-form')
      commentLikeForms.forEach((commentLikeForm) => {
        commentLikeForm.addEventListener('submit', function (event) {
          event.preventDefault()
          const reviewId = event.currentTarget.dataset.reviewId
          const commentId = event.currentTarget.dataset.commentId
          axios({
            method: 'POST',
            url: `/cafes/${reviewId}/comment_like/${commentId}/`,
            headers: { 'X-CSRFToken': csrftoken },
          })
          .then(response => {
            if (response.data.is_comment_liked) {
              commentLikeForm.querySelector('.bi').classList.add('bi-heart-fill')
              commentLikeForm.querySelector('.bi').classList.remove('bi-heart')
            }
            else {
              commentLikeForm.querySelector('.bi').classList.add('bi-heart')
              commentLikeForm.querySelector('.bi').classList.remove('bi-heart-fill')
            }
            commentLikeForm.querySelector('.comment-like-count').innerText = response.data.comment_like_count
          })
        })
      })
    }

    function commentUpdate(dom) {
      const commentUpdateForms = dom.querySelectorAll('.comment-update-form')
      commentUpdateForms.forEach((commentUpdateForm) => {
        commentUpdateForm.addEventListener('submit', function (event) {
          event.preventDefault()
          const reviewId = event.currentTarget.dataset.reviewId
          const commentId = event.currentTarget.dataset.commentId
          axios({
            method: 'POST',
            url: `/cafes/${reviewId}/comment_update/${commentId}/`,
            headers: { 'X-CSRFToken': csrftoken },
            data: new FormData(commentUpdateForm) // 폼에 있는 정보를 data로 넘겨줄 수 있도록 변환
          })
          .then(response => {
            dom.querySelector(`#comment-${commentId}-block`).classList.remove('d-none')
            dom.querySelector(`#comment-${commentId}-block`).classList.add('d-block')
            dom.querySelector(`#comment-${commentId}-update`).classList.remove('d-block')
            dom.querySelector(`#comment-${commentId}-update`).classList.add('d-none')
            dom.querySelector(`#comment-${commentId}-update .form-control`).value = response.data.content
            dom.querySelector(`#comment-${commentId}-content`).innerText = response.data.content
          })
        })
      })
    }

    function commentDelete(dom) {
      const commentDeleteForms = dom.querySelectorAll('.comment-delete-form')
      commentDeleteForms.forEach((commentDeleteForm) => {
        commentDeleteForm.addEventListener('submit', function (event) {
          event.preventDefault()
          const reviewId = event.currentTarget.dataset.reviewId
          const commentId = event.currentTarget.dataset.commentId
          axios({
            method: 'POST',
            url: `/cafes/${reviewId}/comment_delete/${commentId}/`,
            headers: { 'X-CSRFToken': csrftoken },
          })
          .then(response => {
            console.log(response.data)
            dom.querySelector(`.comment-${reviewId}-count`).innerText = response.data.comments_count
            const comments = response.data.comments
            const commentsArea = document.querySelector(`#comment-area-${reviewId}`)

            while (commentsArea.hasChildNodes()) {
              commentsArea.removeChild(commentsArea.firstChild)
            }

            if (response.data.request_is_authenticated) {
              commentsArea.insertAdjacentHTML('beforeend', `
                <form class="comment-create-form" data-review-id="${reviewId}">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-fill me-2">
                      <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true">
                    </div>
                    <div>
                      <input class="btn btn-primary" type="submit" value="작성">
                    </div>
                  </div>
                </form>
                <hr>
              `)
            }

            for (let i = 0; i < comments.length; i++) {
              if (comments[i].parent == null) {
                commentsArea.insertAdjacentHTML('beforeend', `
                  <div id="comment-${comments[i].pk}">
                    <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                    </div>
                    <div id="comment-${comments[i].pk}-update" class="d-none">
                    </div>
                    <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                    </div>
                    <div id="reply-form-${comments[i].pk}" class="d-none">
                    </div>
                  </div>
                  <hr>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  `)
                }
              }
              else {
                dom.querySelector(`#comment-${comments[i].parent}`).insertAdjacentHTML('beforeend', `
                  <div class="d-flex">
                    <a href="#comment-${comments[i].parent}" class="m-2"><i class="bi bi-arrow-return-right"></i></a>
                    <div class="flex-fill">
                      <div id="comment-${comments[i].pk}">
                        <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                        </div>
                        <div id="comment-${comments[i].pk}-update" class="d-none">
                        </div>
                        <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                        </div>
                        <div id="reply-form-${comments[i].pk}" class="d-none">
                        </div>
                      </div>
                    </div>
                  </div>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  `)
                }
              }
            }
            
            return commentsArea.offsetParent
          })
          .then(response => {
            commentUpdateBtn(response)
            replyBtn(response)
            commentLike(response)
            commentUpdate(response)
            commentCreate(response)
            commentDelete(response)
            replyCreate(response)
          })
        })
      })
    }

    function replyCreate(dom) {
      const replyCreateForms = dom.querySelectorAll('.reply-create-form')
      replyCreateForms.forEach((replyCreateForm) => {
        replyCreateForm.addEventListener('submit', function (event) {
          event.preventDefault()
          const reviewId = event.currentTarget.dataset.reviewId
          const commentId = event.currentTarget.dataset.commentId
          axios({
            method: 'POST',
            url: `/cafes/${reviewId}/reply_create/${commentId}/`,
            headers: { 'X-CSRFToken': csrftoken },
            data: new FormData(replyCreateForm) // 폼에 있는 정보를 data로 넘겨줄 수 있도록 변환
          })
          .then(response => {
            console.log(response.data)
            dom.querySelector(`.comment-${reviewId}-count`).innerText = response.data.comments_count
            const comments = response.data.comments
            const commentsArea = document.querySelector(`#comment-area-${reviewId}`)

            while (commentsArea.hasChildNodes()) {
              commentsArea.removeChild(commentsArea.firstChild)
            }

            if (response.data.request_is_authenticated) {
              commentsArea.insertAdjacentHTML('beforeend', `
                <form class="comment-create-form" data-review-id="${reviewId}">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-fill me-2">
                      <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true">
                    </div>
                    <div>
                      <input class="btn btn-primary" type="submit" value="작성">
                    </div>
                  </div>
                </form>
                <hr>
              `)
            }

            for (let i = 0; i < comments.length; i++) {
              if (comments[i].parent == null) {
                commentsArea.insertAdjacentHTML('beforeend', `
                  <div id="comment-${comments[i].pk}">
                    <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                    </div>
                    <div id="comment-${comments[i].pk}-update" class="d-none">
                    </div>
                    <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                    </div>
                    <div id="reply-form-${comments[i].pk}" class="d-none">
                    </div>
                  </div>
                  <hr>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  `)
                }
              }
              else {
                dom.querySelector(`#comment-${comments[i].parent}`).insertAdjacentHTML('beforeend', `
                  <div class="d-flex">
                    <a href="#comment-${comments[i].parent}" class="m-2"><i class="bi bi-arrow-return-right"></i></a>
                    <div class="flex-fill">
                      <div id="comment-${comments[i].pk}">
                        <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                        </div>
                        <div id="comment-${comments[i].pk}-update" class="d-none">
                        </div>
                        <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                        </div>
                        <div id="reply-form-${comments[i].pk}" class="d-none">
                        </div>
                      </div>
                    </div>
                  </div>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  `)
                }
              }
            }

            return commentsArea.offsetParent
          })
          .then(response => {
            commentUpdateBtn(response)
            replyBtn(response)
            commentLike(response)
            commentUpdate(response)
            commentCreate(response)
            commentDelete(response)
            replyCreate(response)
          })
        })
      })
    }

    function commentCreate(dom) {
      const commentCreateForms = dom.querySelectorAll('.comment-create-form')
      commentCreateForms.forEach((commentCreateForm) => {
        commentCreateForm.addEventListener('submit', function (event) {
          event.preventDefault()
          const reviewId = event.currentTarget.dataset.reviewId
          axios({
            method: 'POST',
            url: `/cafes/${reviewId}/comment_create/`,
            headers: { 'X-CSRFToken': csrftoken },
            data: new FormData(commentCreateForm) // 폼에 있는 정보를 data로 넘겨줄 수 있도록 변환
          })
          .then(response => {
            console.log(response.data)
            dom.querySelector(`.comment-${reviewId}-count`).innerText = response.data.comments_count
            const comments = response.data.comments
            const commentsArea = document.querySelector(`#comment-area-${reviewId}`)

            while (commentsArea.hasChildNodes()) {
              commentsArea.removeChild(commentsArea.firstChild)
            }

            if (response.data.request_is_authenticated) {
              commentsArea.insertAdjacentHTML('beforeend', `
                <form class="comment-create-form" data-review-id="${reviewId}">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-fill me-2">
                      <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true">
                    </div>
                    <div>
                      <input class="btn btn-primary" type="submit" value="작성">
                    </div>
                  </div>
                </form>
                <hr>
              `)
            }

            for (let i = 0; i < comments.length; i++) {
              if (comments[i].parent == null) {
                commentsArea.insertAdjacentHTML('beforeend', `
                  <div id="comment-${comments[i].pk}">
                    <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                    </div>
                    <div id="comment-${comments[i].pk}-update" class="d-none">
                    </div>
                    <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                    </div>
                    <div id="reply-form-${comments[i].pk}" class="d-none">
                    </div>
                  </div>
                  <hr>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                    <hr>
                  `)
                }
              }
              else {
                dom.querySelector(`#comment-${comments[i].parent}`).insertAdjacentHTML('beforeend', `
                  <div class="d-flex">
                    <a href="#comment-${comments[i].parent}" class="m-2"><i class="bi bi-arrow-return-right"></i></a>
                    <div class="flex-fill">
                      <div id="comment-${comments[i].pk}">
                        <div id="comment-${comments[i].pk}-block" class="d-flex mb-1 d-block">
                        </div>
                        <div id="comment-${comments[i].pk}-update" class="d-none">
                        </div>
                        <div id="comment-${comments[i].pk}-btn" class="d-flex justify-content-between">
                        </div>
                        <div id="reply-form-${comments[i].pk}" class="d-none">
                        </div>
                      </div>
                    </div>
                  </div>
                `)
                if (comments[i].profile == null) {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="https://dummyimage.com/100x100" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }
                else {
                  dom.querySelector(`#comment-${comments[i].pk}-block`).insertAdjacentHTML('beforeend', `
                    <img class="rounded" src="${comments[i].profile}" alt="기본 프로필 사진" style="max-height: 100px">
                    <div class="ms-4 flex-fill d-flex flex-column justify-content-between">
                      <div class="my-2">
                        <a href="/accounts/profile/${comments[i].username}/">${comments[i].username}</a>
                      </div>
                      <div id="comment-${comments[i].pk}-content" class="my-2">${comments[i].content}</div>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#comment-${comments[i].pk}-update`).insertAdjacentHTML('beforeend', `
                    <form class="comment-update-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="댓글을 남겨보세요 💬" class="form-control" required="true" value="${comments[i].content}">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="수정">
                        </div>
                      </div>
                    </form>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  if (comments[i].is_liked) {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart-fill"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                  else {
                    dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                      <div class="d-flex">
                        <button class="btn btn-sm border-0 text-secondary reply-btn" data-comment-id="${comments[i].pk}">
                          <i class="bi bi-chat-left-dots"></i>
                          <span class="ms-2 reply-count">${comments[i].reply_count}</span>
                        </button>
                        <form class="comment-like-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                          <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                          <button class="btn btn-sm border-0 text-danger" type="submit">
                            <i class="bi bi-heart"></i>
                            <span class="ms-2 comment-like-count">${comments[i].like_count}</span>
                          </button>
                        </form>
                      </div>
                    `)
                  }
                }

                if (comments[i].username == response.data.request_username) {
                  dom.querySelector(`#comment-${comments[i].pk}-btn`).insertAdjacentHTML('beforeend', `
                    <div class="d-flex">
                      <button class="btn btn-sm border-0 text-black comment-update-btn" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form class="comment-delete-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                        <button class="btn btn-sm border-0 text-danger" type="submit">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  `)
                }

                if (response.data.request_is_authenticated) {
                  dom.querySelector(`#reply-form-${comments[i].pk}`).insertAdjacentHTML('beforeend', `
                    <hr>
                    <form class="reply-create-form" data-review-id="${reviewId}" data-comment-id="${comments[i].pk}">
                      <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-fill me-2">
                          <input type="text" name="content" placeholder="대댓글을 남겨보세요 💬" class="form-control" required="true">
                        </div>
                        <div>
                          <input class="btn btn-primary" type="submit" value="작성">
                        </div>
                      </div>
                    </form>
                  `)
                }
              }
            }

            return commentsArea.offsetParent
          })
          .then(response => {
            commentUpdateBtn(response)
            replyBtn(response)
            commentLike(response)
            commentUpdate(response)
            commentCreate(response)
            commentDelete(response)
            replyCreate(response)
          })
        })
      })
    }

    const reviewAreaAll = document.querySelectorAll('.review-area')
    reviewAreaAll.forEach((reviewArea) => {
      commentUpdateBtn(reviewArea)
      replyBtn(reviewArea)
      commentLike(reviewArea)
      commentUpdate(reviewArea)
      commentDelete(reviewArea)
      replyCreate(reviewArea)
      commentCreate(reviewArea)
    })
  </script>
{% endblock js %}
